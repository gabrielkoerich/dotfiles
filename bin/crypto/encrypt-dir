#!/usr/bin/env bash
set -euo pipefail

src="${1:-}"
out="${2:-}"
recipient="${AGE_RECIPIENT:-}"

if [[ -z "$src" || -z "$out" ]]; then
  echo "usage: encrypt-dir <src-dir> <output.tar.age>" >&2
  exit 2
fi

if [[ -z "$recipient" ]]; then
  echo "error: set AGE_RECIPIENT env var" >&2
  exit 1
fi

tmp_tar="$(mktemp /tmp/dotfiles-enc.XXXXXX.tar)"
trap 'rm -f "$tmp_tar"' EXIT

tar -cf "$tmp_tar" -C "$(dirname "$src")" "$(basename "$src")"
age -r "$recipient" -o "$out" "$tmp_tar"
echo "encrypted dir: $out"
