#!/usr/bin/env bash
set -euo pipefail

status=0

echo "==> Checking Brewfile dependencies"
if ! brew bundle check --file Brewfile --verbose; then
  status=1
fi

echo "==> Checking for extra installed packages not in Brewfile"
# cleanup without --force returns 1 if removals are needed
if ! brew bundle cleanup --file Brewfile --dry-run >/dev/null 2>&1; then
  echo "drift: extra brew/cask items installed that are not in Brewfile"
  status=1
else
  echo "ok: no extra brew/cask drift detected"
fi

echo "==> Running doctor + strict security"
if ! ./bin/doctor; then
  status=1
fi
if ! ./bin/security-audit --strict; then
  status=1
fi

if [[ "$status" -eq 0 ]]; then
  echo "exact-check passed"
else
  echo "exact-check found drift"
fi

exit "$status"
