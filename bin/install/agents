#!/usr/bin/env bash

set -euo pipefail

ANTHROPIC_SKILLS_REF="1ed29a03dc852d30fa6ef2ca53a67dc2c2c2c563"
GB_SKILLS_REF="f51efdd613d8259b04225137551eb61149c82a5c"

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: required command not found: $1" >&2
    exit 1
  fi
}

clone_pinned() {
  local repo_url="$1"
  local ref="$2"
  local dest="$3"

  if [[ ! "$ref" =~ ^[0-9a-f]{40}$ ]]; then
    echo "error: expected full 40-char commit SHA, got: $ref" >&2
    exit 1
  fi

  git init "$dest" >/dev/null
  git -C "$dest" remote add origin "$repo_url"
  git -C "$dest" fetch --depth 1 origin "$ref"
  git -C "$dest" checkout --detach FETCH_HEAD >/dev/null
}

sync_skills_to_agents() {
  local src="$1"
  mkdir -p "$HOME/.claude/skills" "$HOME/.codex/skills" "$HOME/.config/opencode/skills"
  rsync -avh --no-perms --exclude ".git/" --exclude ".DS_Store" "$src"/ "$HOME/.claude/skills/"
  rsync -avh --no-perms --exclude ".git/" --exclude ".DS_Store" "$src"/ "$HOME/.codex/skills/"
  rsync -avh --no-perms --exclude ".git/" --exclude ".DS_Store" "$src"/ "$HOME/.config/opencode/skills/"
}

require_cmd brew
require_cmd git
require_cmd just
require_cmd rsync

brew install codex
brew install claude-code
brew install opencode
brew install gabrielkoerich/tap/orchestrator

tmp_skills_dir="$(mktemp -d)"
tmp_anthropic_skills_dir="$(mktemp -d)"

cleanup() {
  rm -rf "$tmp_skills_dir" "$tmp_anthropic_skills_dir"
}
trap cleanup EXIT

clone_pinned "https://github.com/gabrielkoerich/skills.git" "$GB_SKILLS_REF" "$tmp_skills_dir"
sync_skills_to_agents "$tmp_skills_dir"

clone_pinned "https://github.com/anthropics/skills.git" "$ANTHROPIC_SKILLS_REF" "$tmp_anthropic_skills_dir"
sync_skills_to_agents "$tmp_anthropic_skills_dir/skills"

# Sync AGENTS.md to all agents
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
mkdir -p "$HOME/.codex" "$HOME/.config/opencode" "$HOME/.claude"
cp "$script_dir/AGENTS.md" "$HOME/.codex/AGENTS.md"
cp "$script_dir/AGENTS.md" "$HOME/.config/opencode/AGENTS.md"
cp "$script_dir/AGENTS.md" "$HOME/.claude/CLAUDE.md"
