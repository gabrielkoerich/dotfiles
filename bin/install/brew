#!/usr/bin/env bash

set -euo pipefail

echo 'Starting...';

# Check to see if Homebrew is installed, and install it if it is not
command -v brew >/dev/null 2>&1 || {
    echo >&2 "Installing Homebrew"; \

    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
}

# Install formulas from Brewfile (no casks in this target)
brew bundle --file Brewfile --no-cask --verbose

# Install oh-my-zsh
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
fi

# Note: donâ€™t forget to add `/usr/local/bin/zsh` to `/etc/shells` before
# running `chsh`.
chsh -s $(which zsh)

## Add command-time plugin
git clone https://github.com/popstas/zsh-command-time.git ~/.oh-my-zsh/custom/plugins/command-time

# Fix penetry mac alias
if command -v pinentry-touchid >/dev/null 2>&1; then
  pinentry-touchid -fix
fi
# Don't save password on keychain
defaults write org.gpgtools.common UseKeychain -bool yes

# brew install utm # VM for ARM Macs
# brew install testssl
# brew install lua
# brew install rename
# brew install vbindiff
# brew install webkit2png
# brew install zopfli

# Install and configure TPM
if [[ ! -d "$HOME/.tmux/plugins/tpm" ]]; then
  git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi

# Install TPM plugins.
# TPM requires running tmux server, as soon as `tmux start-server` does not work
# create dump __noop session in detached mode, and kill it when plugins are installed
printf "Install TPM plugins\n"
tmux new -d -s __noop >/dev/null 2>&1 || true
tmux set-environment -g TMUX_PLUGIN_MANAGER_PATH "~/.tmux/plugins"
"$HOME"/.tmux/plugins/tpm/bin/install_plugins || true
tmux kill-session -t __noop >/dev/null 2>&1 || true

# Remove outdated versions from the cellar.
brew cleanup
brew doctor

# List services to check them
brew services list
