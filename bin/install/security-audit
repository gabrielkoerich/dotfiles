#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   ./bin/install/security-audit                     # repo defaults
#   ./bin/install/security-audit <file-or-dir> ...
#   ./bin/install/security-audit --strict <targets> # fail on risky patterns

strict=0
ignore_file="${SECURITY_AUDIT_IGNORE:-.security-audit-ignore}"
targets=()

for arg in "$@"; do
  case "$arg" in
    --strict) strict=1 ;;
    *) targets+=("$arg") ;;
  esac
done

if [[ ${#targets[@]} -eq 0 ]]; then
  targets=(bin private Justfile README.md)
fi

files=()
for t in "${targets[@]}"; do
  if [[ -f "$t" ]]; then
    files+=("$t")
  elif [[ -d "$t" ]]; then
    while IFS= read -r f; do
      files+=("$f")
    done < <(find "$t" -type f -not -path '*/.git/*' -not -name '.DS_Store')
  else
    echo "warning: target not found, skipping: $t"
  fi
done

if [[ ${#files[@]} -eq 0 ]]; then
  echo "error: no files found to audit" >&2
  exit 2
fi

echo "==> Security audit: ${#files[@]} files"

status=0
syntax_fail=0
shellcheck_fail=0
risky_hits=0

shell_files=()
scan_files=()
for f in "${files[@]}"; do
  # Files to run pattern scans on
  case "$f" in
    *.md|*.txt|*.png|*.jpg|*.jpeg|*.gif|*.pdf|*.applescript) ;;
    *) scan_files+=("$f") ;;
  esac

  # Shell-like files for bash -n / shellcheck
  case "$f" in
    Justfile|private/Justfile|*.just) continue ;;
  esac

  if head -n 1 "$f" | rg -q '^#!.*(bash|sh|zsh)'; then
    shell_files+=("$f")
    continue
  fi

  case "$f" in
    bin/*|private/bin/*|private/install/*) shell_files+=("$f") ;;
  esac
done

echo "-> bash -n (${#shell_files[@]} files)"
for f in "${shell_files[@]}"; do
  if ! bash -n "$f"; then
    ((syntax_fail += 1))
  fi
done
if [[ "$syntax_fail" -gt 0 ]]; then
  echo "error: bash syntax failures: $syntax_fail"
  status=1
fi

echo "-> shellcheck (${#shell_files[@]} files)"
if command -v shellcheck >/dev/null 2>&1; then
  for f in "${shell_files[@]}"; do
    if ! shellcheck "$f"; then
      ((shellcheck_fail += 1))
    fi
  done
  if [[ "$shellcheck_fail" -gt 0 ]]; then
    echo "error: shellcheck failures: $shellcheck_fail"
    status=1
  fi
else
  echo "warning: shellcheck not installed; skipping static shell lint"
fi

echo "-> risky pattern scan (${#scan_files[@]} files)"
raw_hits="$(mktemp)"
filtered_hits="$(mktemp)"
trap 'rm -f "$raw_hits" "$filtered_hits"' EXIT

if rg -n \
  -e 'curl[[:space:]].*\|[[:space:]]*(sh|bash)' \
  -e 'wget[[:space:]].*\|[[:space:]]*(sh|bash)' \
  -e 'sh[[:space:]]+-c[[:space:]]+"\$\(curl' \
  -e 'eval[[:space:]]' \
  -e 'chmod[[:space:]]+777' \
  -e 'rm[[:space:]]+-rf[[:space:]]+/' \
  -e 'mktemp[[:space:]]+-u' \
  -e 'sudo[[:space:]]' \
  "${scan_files[@]}" >"$raw_hits"; then
  # Drop pure comment-line hits (path:line:# ...)
  grep -Ev '^[^:]+:[0-9]+:[[:space:]]*#' "$raw_hits" >"$filtered_hits" || true

  if [[ -f "$ignore_file" ]] && [[ -s "$ignore_file" ]]; then
    grep -Evf "$ignore_file" "$filtered_hits" >"$raw_hits" || true
    mv "$raw_hits" "$filtered_hits"
  fi

  if [[ -s "$filtered_hits" ]]; then
    cat "$filtered_hits"
    risky_hits=1
  else
    echo "ok: only ignored risky patterns matched"
  fi

  if [[ "$strict" -eq 1 ]]; then
    if [[ "$risky_hits" -eq 1 ]]; then
      echo "error: risky patterns found (strict mode)"
      status=1
    fi
  else
    if [[ "$risky_hits" -eq 1 ]]; then
      echo "warning: risky patterns found (non-strict mode)"
    fi
  fi
else
  echo "ok: no risky patterns matched"
fi

echo "==> Summary"
echo "shell files: ${#shell_files[@]}"
echo "syntax failures: $syntax_fail"
echo "shellcheck failures: $shellcheck_fail"
echo "risky patterns: $risky_hits"

if [[ "$status" -eq 0 ]]; then
  echo "security audit passed"
else
  echo "security audit failed"
fi

exit "$status"
