#!/usr/bin/env bash
set -euo pipefail

SESSION="${TMX_SESSION_NAME:-main}"
SESSIONS="${TMX_SESSIONS:-$SESSION}"
ROOT_DIR="${TMX_SESSION_ROOT:-$HOME}"
MODE="${1:-attach}"

ensure_session() {
  local s="${1}"
  if ! tmux has-session -t "$s" 2>/dev/null; then
    tmux new-session -d -s "$s" -c "$ROOT_DIR"
  fi
}

ensure_sessions() {
  local s
  for s in $SESSIONS; do
    ensure_session "$s"
  done
}

case "$MODE" in
  ensure)
    ensure_sessions
    ;;
  attach|"")
    ensure_sessions
    if [[ -n "${TMUX:-}" ]]; then
      exec tmux switch-client -t "$SESSION"
    else
      exec tmux attach-session -t "$SESSION"
    fi
    ;;
  *)
    echo "usage: tmx [attach|ensure]" >&2
    exit 2
    ;;
esac
